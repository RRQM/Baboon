name: Build and Publish NuGet Packages

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'src/Baboon.slnx'

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install .NET MAUI workload
      run: dotnet workload install maui-android maui-ios maui

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build all projects
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

    - name: Run tests (if any)
      run: dotnet test ${{ env.SOLUTION_PATH }} --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"
      continue-on-error: true

    - name: Pack all NuGet packages
      run: |
        Write-Host "Packing NuGet packages from solution..."
        dotnet pack ${{ env.SOLUTION_PATH }} --configuration Release --no-build --output ./packages
        Write-Host "All packages packed successfully!"

    - name: List packages for debugging
      run: Get-ChildItem -Path "./packages" -Recurse

    - name: Upload NuGet packages as artifact
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./packages/*.nupkg

  publish-nuget:
    needs: build-and-test
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download NuGet packages artifact
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./packages

    - name: Verify packages exist
      run: |
        if (-not (Test-Path "./packages/*.nupkg")) {
          Write-Error "No .nupkg files found in ./packages directory"
          Get-ChildItem -Path "./packages" -Recurse
          exit 1
        }
        Write-Host "Found packages:"
        Get-ChildItem -Path "./packages" -Filter "*.nupkg"

    - name: Check and publish NuGet packages
      run: |
        $nupkgFiles = Get-ChildItem -Path "./packages" -Filter "*.nupkg"
        
        foreach ($file in $nupkgFiles) {
          Write-Host "`n========================================"
          Write-Host "Processing: $($file.Name)"
          Write-Host "========================================"
          
          # 从文件名提取包名和版本号
          $fileName = $file.BaseName
          if ($fileName -match '(.+)\.(\d+\.\d+\.\d+.*)') {
            $packageName = $matches[1]
            $version = $matches[2]
            
            Write-Host "Package: $packageName"
            Write-Host "Version: $version"
            
            # 检查版本是否已存在
            $shouldPublish = $true
            try {
              $response = Invoke-RestMethod -Uri "https://api.nuget.org/v3-flatcontainer/$($packageName.ToLower())/index.json" -Method Get
              $existingVersions = $response.versions
              
              if ($existingVersions -contains $version) {
                Write-Host "Version $version already exists on NuGet.org. Skipping."
                $shouldPublish = $false
              } else {
                Write-Host "Version $version does not exist. Will publish."
              }
            } catch {
              if ($_.Exception.Response.StatusCode -eq 404) {
                Write-Host "Package not found on NuGet.org. This might be the first publish."
              } else {
                Write-Host "Could not check existing versions. Will attempt to publish with --skip-duplicate."
              }
            }
            
            # 发布包
            if ($shouldPublish) {
              Write-Host "Publishing $($file.Name)..."
              dotnet nuget push $file.FullName `
                --api-key ${{ secrets.NUGET_API_KEY }} `
                --source https://api.nuget.org/v3/index.json `
                --skip-duplicate
              Write-Host "Published successfully!"
            }
          } else {
            Write-Host "Warning: Could not parse package name and version from $($file.Name)"
          }
        }
        
        Write-Host "`n========================================"
        Write-Host "All packages processed!"
        Write-Host "========================================"
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
